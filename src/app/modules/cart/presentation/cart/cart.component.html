<div class="w-full h-full p-4">
    <div class="flex gap-4 w-full h-full">
        <div class="flex flex-col h-full w-[calc(100%-300px)] gap-3">
            <div class="w-full h-auto">
                <p-card>
                    <div class="w-full h-full">

                        <div class="flex w-full h-[cacl(100%-45px)] ">
                            <div class="flex justify-between items-center w-full">
                                <p-breadcrumb [model]="breadCrumb" />
                                <p-button
                                    (click)="onDeleteAll()"
                                    (keydown.enter)="onDeleteAll()"
                                    label="Vaciar carrito"
                                    icon="pi pi-trash"
                                    severity="danger"
                                    [disabled]="items.length === 0"></p-button>
                            </div>
                        </div>
                    </div>
                </p-card>
            </div>
            <div class="w-full h-[calc(100%-64px)] overflow-y-auto flex flex-col justify-start gap-2">
                <div class="h-[140px]" *ngFor="let item of items">
                    <p-card>
                        <div class="flex w-full gap-3 h-[100px]">
                            <img [src]="item.productImage || 'assets/image-not-found.svg'" class="h-full" alt="Not found">

                            <div class="flex-1">
                                <h4 class="font-medium text-xl">{{ item.productName }}</h4>
                                <p class="font-medium text-[15px] text-gray-500">S/ {{ item.productPrice | number:'1.2-2' }}</p>
                                <p class="font-medium text-[15px] text-gray-500">Cantidad: {{ item.amount }}</p>
                            </div>

                            <div class="flex flex-col w-[135px] justify-between">
                                <p-inputnumber [(ngModel)]="item.amount" [showButtons]="true" buttonLayout="horizontal" class="text-center"
                                    [min]="1" [max]="999" [inputId]="'horizontal-' + item.id" spinnerMode="horizontal" fluid>
                                    <ng-template #incrementbuttonicon>
                                        <span class="pi pi-plus"></span>
                                    </ng-template>
                                    <ng-template #decrementbuttonicon>
                                        <span class="pi pi-minus"></span>
                                    </ng-template>
                                </p-inputnumber>

                                <p-button
                                    (click)="onDelete(item)"
                                    (keydown.enter)="onDelete(item)"
                                    fluid
                                    label="Eliminar"
                                    severity="danger"
                                    icon="pi pi-trash"></p-button>

                            </div>

                        </div>
                    </p-card>
                </div>
                <div *ngIf="items.length === 0" class="opacity-70 text-center py-6">Tu carrito está vacío.</div>
            </div>
        </div>
        <div class="w-[300px] h-full flex flex-col overflow-y-auto justify-start">
            <div>
                <p-card>
                    <div class="flex flex-col gap-3 w-full h-full overflow-y-auto">
                        <h3 class="text-xl font-semibold">Resumen de compra</h3>
                        <ul class="list-disc list-inside flex flex-col gap-1" *ngIf="items.length > 0; else emptySummary">
                            <li *ngFor="let it of items">{{ it.productName }} x{{ it.amount }} — S/ {{ (it.productPrice * it.amount) | number:'1.2-2' }}</li>
                        </ul>
                        <ng-template #emptySummary>
                            <div class="opacity-70">No hay productos.</div>
                        </ng-template>

                        <div class="flex justify-between">
                            <p class="font-semibold">TOTAL</p>
                            <p>S/ {{ total | number:'1.2-2' }}</p>
                        </div>

                        <p-button
                            fluid
                            label="Comprar"
                            (onClick)="buy()"
                            (keydown.enter)="buy()"
                            icon="pi pi-shopping-bag"
                            [disabled]="items.length === 0"></p-button>
                    </div>
                </p-card>
            </div>
        </div>
    </div>
</div>

<p-dialog
    [(visible)]="checkoutDialogVisible"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '520px' }"
    [breakpoints]="{ '960px': '95vw' }"
    header="Datos para el envío"
    (onHide)="closeCheckoutDialog()">
    <form [formGroup]="checkoutForm" class="flex flex-col gap-3">
        <div class="flex flex-col gap-2">
            <label for="contactName" class="font-medium text-sm">Nombre de contacto</label>
            <input pInputText id="contactName" formControlName="contactName" placeholder="Nombre de quien recibe" />
            <p-message *ngIf="checkoutForm.get('contactName')?.invalid && checkoutForm.get('contactName')?.touched" severity="error" text="Requerido"></p-message>
        </div>

        <div class="flex flex-col gap-2">
            <label for="address" class="font-medium text-sm">Dirección</label>
            <input pInputText id="address" formControlName="address" placeholder="Av. Siempre Viva 123" />
            <p-message *ngIf="checkoutForm.get('address')?.invalid && checkoutForm.get('address')?.touched" severity="error" text="Requerido"></p-message>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="flex flex-col gap-2">
                <label for="region" class="font-medium text-sm">Región (Departamento)</label>
                <input pInputText id="region" formControlName="region" placeholder="Región / Departamento" />
                <p-message *ngIf="checkoutForm.get('region')?.invalid && checkoutForm.get('region')?.touched" severity="error" text="Requerido"></p-message>
            </div>
            <div class="flex flex-col gap-2">
                <label for="district" class="font-medium text-sm">Distrito</label>
                <input pInputText id="district" formControlName="district" placeholder="Distrito" />
                <p-message *ngIf="checkoutForm.get('district')?.invalid && checkoutForm.get('district')?.touched" severity="error" text="Requerido"></p-message>
            </div>
            <div class="flex flex-col gap-2">
                <label for="province" class="font-medium text-sm">Provincia</label>
                <input pInputText id="province" formControlName="province" placeholder="Provincia" />
                <p-message *ngIf="checkoutForm.get('province')?.invalid && checkoutForm.get('province')?.touched" severity="error" text="Requerido"></p-message>
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <label for="reference" class="font-medium text-sm">Referencia</label>
            <textarea id="reference" pTextarea formControlName="reference" rows="2" placeholder="Punto de referencia o indicaciones"></textarea>
            <p-message *ngIf="checkoutForm.get('reference')?.invalid && checkoutForm.get('reference')?.touched" severity="error" text="Requerido"></p-message>
        </div>

        <div class="flex flex-col gap-2">
            <label for="phoneNumber" class="font-medium text-sm">Teléfono</label>
            <input pInputText id="phoneNumber" formControlName="phoneNumber" placeholder="987654321" maxlength="9" />
            <p-message *ngIf="checkoutForm.get('phoneNumber')?.invalid && checkoutForm.get('phoneNumber')?.touched" severity="error" text="Debe tener 9 dígitos numéricos"></p-message>
        </div>

        <div class="flex justify-end gap-2 pt-2">
            <p-button
                label="Cancelar"
                severity="secondary"
                (onClick)="closeCheckoutDialog()"></p-button>
            <p-button
                label="Finalizar compra"
                icon="pi pi-check"
                [loading]="purchasing"
                (onClick)="submitPurchase()"></p-button>
        </div>
    </form>
</p-dialog>
