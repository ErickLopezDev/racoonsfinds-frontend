<div class="h-full p-5 w-full">
  <div class="flex gap-3 w-full h-full">
    <section class="h-full w-[250px]">
      <p-card>
        <div class="w-full h-full overflow-y-auto">
          <h3 class="text-2xl mb-2 font-bold">Categorias</h3>

          <ul class="flex flex-col">
            @for (cat of category(); track $index) {
            <li class="mt-1">
              <p-button
                class="text-left"
                (onClick)="selectCategory(cat.id)"
                (keydown.enter)="selectCategory(cat.id)"
                [variant]="cat.id == categorySelected() ? 'outlined' : 'text'"
                [label]="cat.name"
                [severity]="
                  cat.id == categorySelected() ? undefined : 'secondary'
                "
              />
            </li>
            }
          </ul>
        </div>
      </p-card>
    </section>
    <div class="h-full flex gap-3 flex-col flex-1">
      <section class="h-[70px] w-full">
        <p-card>
          <div class="w-full h-full flex items-center">
            <span class="mr-2 font-semibold">Buscar:</span>
            <span class="text-xl line-clamp-1">{{ searchName() ?? "-" }}</span>
          </div>
        </p-card>
      </section>

      <section class="h-[calc(100%-70px)] overflow-y-auto w-full">
        @if(loadingProducts()) {
        <div class="rounded border border-surface-200 dark:border-surface-700 p-6 bg-surface-0 dark:bg-surface-900">
          <ul class="m-0 p-0 list-none">
            <li class="mb-4">
              <div class="flex">
                <p-skeleton shape="circle" size="4rem" styleClass="mr-2" />
                <div class="self-center" style="flex: 1">
                  <p-skeleton width="100%" styleClass="mb-2" />
                  <p-skeleton width="75%" />
                </div>
              </div>
            </li>
            <li class="mb-4">
              <div class="flex">
                <p-skeleton shape="circle" size="4rem" styleClass="mr-2" />
                <div class="self-center" style="flex: 1">
                  <p-skeleton width="100%" styleClass="mb-2" />
                  <p-skeleton width="75%" />
                </div>
              </div>
            </li>
            <li class="mb-4">
              <div class="flex">
                <p-skeleton shape="circle" size="4rem" styleClass="mr-2" />
                <div class="self-center" style="flex: 1">
                  <p-skeleton width="100%" styleClass="mb-2" />
                  <p-skeleton width="75%" />
                </div>
              </div>
            </li>
            <li>
              <div class="flex">
                <p-skeleton shape="circle" size="4rem" styleClass="mr-2" />
                <div class="self-center" style="flex: 1">
                  <p-skeleton width="100%" styleClass="mb-2" />
                  <p-skeleton width="75%" />
                </div>
              </div>
            </li>
          </ul>
        </div>
        } @else {
        <div class="flex flex-col gap-2">
          @if (products().length === 0) {
          <p-card>
            <div class="flex flex-col items-start gap-2 text-gray-600">
              <h4 class="text-lg font-semibold text-gray-800">Aún no hay productos en esta categoría</h4>
              <p>Comienza a vender y sé el primero en publicar algo aquí.</p>
            </div>
          </p-card>
          }
          @for (product of products(); track $index) {
          <p-card>
            <div class="flex w-full gap-3 min-h-[100px]">
              <img
                src="{{
                  product.image ? product.image : 'assets/image-not-found.svg'
                }}"
                class="w-[160px] h-full"
                alt="{{ product.name }}"
              />

              <div class="flex-1">
                <h4 class="font-medium text-xl">{{ product.name }}</h4>
                <p class="font-medium text-[15px] line-clamp-2 text-gray-500">
                  {{ product.description }}
                </p>
                <p class="font-medium text-[15px] text-gray-500">
                  S/ {{ product.price }}
                </p>
                <div class="flex items-center gap-2 text-[14px] text-gray-500">
                  <i class="pi pi-star-fill text-yellow-500 text-[12px]"></i>
                  <span class="font-semibold text-gray-700">{{ product.averageRating ?? 0 }}</span>
                  <span>({{ product.reviewCount ?? 0 }} reseñas)</span>
                </div>
                <div class="flex items-center gap-2 text-[14px] text-gray-600">
                  @if (product.userImage) {
                  <img
                    src="{{ product.userImage }}"
                    alt="{{ product.userName }}"
                    class="w-6 h-6 rounded-full object-cover"
                  />
                  } @else {
                  <i class="pi pi-user text-gray-500 text-[14px]"></i>
                  }
                  <span class="font-medium">{{ product.userName }}</span>
                </div>
                <p class="font-medium text-[15px] text-gray-500">
                  Cantidad: {{ product.stock }}
                </p>
              </div>

              <div class="flex flex-col justify-between items-end text-right">
                <div class="flex gap-2 flex-wrap justify-end">
                  <p-button
                    [outlined]="true"
                    severity="secondary"
                    label="Ver comentarios"
                    (click)="openReviews(product)" (keydown.enter)="openReviews(product)"
                    icon="pi pi-comments"
                  ></p-button>
                  <p-button
                    label="Añadir al carrito"
                    (click)="onAgregarCarrito(product)" (keydown.enter)="onAgregarCarrito(product)"
                    icon="pi pi-shopping-cart"
                  ></p-button>
                  <p-button
                    [outlined]="true"
                    (click)="onAgregarWishList(product)" (keydown.enter)="onAgregarWishList(product)"
                    icon="pi pi-star"
                  ></p-button>
                </div>
                @if(product.stock > 0) {
                <p class="flex items-center gap-2 text-green-500">
                  <i class="pi pi-check"></i> Disponible
                </p>
                }@else {
                <p class="flex items-center gap-2 text-red-500">
                  <i class="pi pi-times"></i> No Disponible
                </p>
                }
              </div>
            </div>
          </p-card>
          } @if (products().length > 10) {
          <div class="w-full flex justify-center">
            <p-button
              label="Ver más"
              [raised]="true"
              severity="secondary"
              (onClick)="showMore()" (keydown.enter)="showMore()"
            />
          </div>
          }
        </div>

        }
      </section>
    </div>
  </div>
</div>

<app-review-products
  [productId]="selectedProduct()?.id ?? null"
  [productName]="selectedProduct()?.name"
  [visible]="showReviews()"
  [canReview]="selectedProduct()?.hasPermission ?? false"
  (close)="closeReviews()"
></app-review-products>
