<p-dialog
  [visible]="visible"
  [modal]="true"
  [style]="{ width: '520px' }"
  [draggable]="false"
  [resizable]="false"
  header="Comentarios"
  (onHide)="onHide()"
  (visibleChange)="onVisibleChange($event)"
>
  <div class="flex flex-col gap-3">
    <div class="text-sm text-gray-600">
      @if (productName) {
      <span class="font-semibold">Producto:</span> {{ productName }}
      }
    </div>

    <div class="flex justify-between items-center">
      <span class="text-sm font-semibold text-gray-700">Reseñas</span>
      <p-button
        label="Escribir reseña"
        icon="pi pi-pencil"
        [outlined]="true"
        size="small"
        (onClick)="startReview()"
      ></p-button>
    </div>

    @if (showForm() && canReview) {
      <div class="flex flex-col gap-2">
        <label class="text-sm font-semibold text-gray-700">Califica y comenta</label>
        <p-rating [(ngModel)]="newStars"></p-rating>
        <textarea
          [(ngModel)]="newComment"
          rows="3"
          class="w-full border border-gray-300 rounded-md p-2 text-sm"
          placeholder="Escribe tu comentario"
        ></textarea>
        <div class="flex justify-end">
          <p-button
            label="Publicar"
            icon="pi pi-send"
            [loading]="submitting()"
            [disabled]="!newComment.trim() || !newStars || submitting()"
            (onClick)="submitReview()"
          ></p-button>
        </div>
      </div>
    }

    @if (!canReview && permissionNotice()) {
      <p class="text-sm text-gray-500">
        Para comentar debes iniciar sesión. Serás redirigido para ingresar a tu cuenta.
      </p>
    }

    @if (loading()) {
      <p-skeleton width="100%" height="60px"></p-skeleton>
      <p-skeleton width="80%" height="60px"></p-skeleton>
    } @else if (reviews().length === 0) {
      <p class="text-gray-600 text-sm">Este producto aún no tiene comentarios.</p>
    } @else {
      <div class="flex flex-col gap-2 max-h-[320px] overflow-y-auto">
        @for (review of reviews(); track $index) {
          <div class="p-3 border border-gray-200 rounded-md bg-gray-50">
            <div class="flex items-center gap-2 mb-1">
              <p-rating
                [ngModel]="review.stars ?? 0"
                [readonly]="true"
                [disabled]="true"
                [stars]="5"
                styleClass="text-yellow-500"
              ></p-rating>
            </div>
            <p class="text-sm text-gray-800">{{ review.comment }}</p>
          </div>
        }
      </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cerrar" (onClick)="onHide()" severity="secondary"></p-button>
  </ng-template>
</p-dialog>
